<!DOCTYPE html>
<!--
    Licensed to the Apache Software Foundation (ASF) under one
    or more contributor license agreements.  See the NOTICE file
    distributed with this work for additional information
    regarding copyright ownership.  The ASF licenses this file
    to you under the Apache License, Version 2.0 (the
    "License"); you may not use this file except in compliance
    with the License.  You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing,
    software distributed under the License is distributed on an
    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
     KIND, either express or implied.  See the License for the
    specific language governing permissions and limitations
    under the License.
-->
<html>

<head>
    <!--
        Customize this policy to fit your own app's needs. For more guidance, see:
            https://github.com/apache/cordova-plugin-whitelist/blob/master/README.md#content-security-policy
        Some notes:
            * gap: is required only on iOS (when using UIWebView) and is needed for JS->native communication
            * https://ssl.gstatic.com is required only on Android and is needed for TalkBack to function properly
            * Disables use of inline scripts in order to mitigate risk of XSS vulnerabilities. To change this:
                * Enable inline JS: add 'unsafe-inline' to default-src
        -->


    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no">
    <meta name="msapplication-tap-highlight" content="no">
    <link rel="stylesheet" type="text/css" href="css/index.css">
    <!-- Color theme for statusbar -->
    <meta name="theme-color" content="#2196f3">
    <!-- Your app title -->
    <title>My App</title>
    <script type="text/javascript" src="cordova.js"></script>
    <!-- Path to Framework7 Library CSS, Material Theme -->
    <link rel="stylesheet" href="css/framework7.material.min.css">
    <!-- Path to Framework7 color related styles, Material Theme -->
    <link rel="stylesheet" href="css/framework7.material.colors.min.css">
    <link rel="stylesheet" href="css/material-icons.css">
    <link rel="stylesheet" href="css/framework7-icons.css">
    <!-- Path to your custom app styles-->
    <link rel="stylesheet" href="css/my-app.css">
</head>

<body>
    <div class="statusbar-overlay "></div>

    <!-- Views -->
    <div class="views">
        <!-- Your main view, should have "view-main" class -->
        <div class="view view-main">

            <!-- Pages container, because we use fixed navbar and toolbar, it has additional appropriate classes-->
            <div class="pages navbar-fixed toolbar-fixed">
                <!-- Page, "data-page" contains page name -->
                <div data-page="index" class="page">

                    <!-- Top Navbar. In Material theme it should be inside of the page-->
                    <div class="navbar theme-green">
                        <div class="navbar-inner">

                            <div class="center">TI SensorTag</div>
                        </div>
                    </div>

                    <!-- Toolbar. In Material theme it should be inside of the page-->
                    <div class="toolbar toolbar-bottom theme-green">
                        <div class="toolbar-inner">

                        </div>
                    </div>

                    <!-- Scrollable page content -->
                    <div class="page-content">
                        <div class="content-block">
                            <div class="row">
                                <div class="col-100">
                                    <div class="card">
                                        <div class="card-header">TI SensorTag CC2650 &amp; CC2541 Sensors</div>
                                        <div class="card-content">
                                            <div class="list-block media-list">
                                                <ul>
                                                    <li class="item-content">
                                                        <div class="item-media">
                                                            <img src="TISensorTagCC2650.png" width="100">
                                                        </div>
                                                        <div class="item-inner">
                                                            <p> Click The Connect Button To Get Started With TI Sensor</p>
                                                        </div>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>
                                        <div class="card-footer">
                                            <a href="#" onclick="connect()" class="button button-raised button-fill color-blue">Connect</a>
                                            <a href="#" onclick="disconnect()" class="button button-raised button-fill color-gray">Disconnect</a>
                                        </div>
                                    </div>
                                </div>
                                <p id="upgradeNotice" class="hidden">
                                    <span class="color-red">Please upgrade the firmware of your SensorTag.</span>
                                </p>
                                <div class="col-100">
                                    <div class="card">
                                        <div class="card-header">Status</div>
                                        <div class="card-content">
                                            <div class="card-content-inner"><span id="StatusData">Press Connect to find the nearest SensorTag</span></div>
                                        </div>
                                        </div>
                                </div>
                                <!-- Accelerometer -->
                                <div class="col-100">
                                    <div class="card">
                                        <div class="card-header">Accelerometer</div>
                                        <div class="card-content">
                                            <div class="card-content-inner"><span id="AccelerometerData">[Waiting for value]</span></div>
                                        </div>
                                         <div class="card-footer">
                                            <p><a href="#" class="button button-raised button-fill color-blue "onclick="startrecordin()">Start Recording</a><br>
                                            <a href="#" class="button button-raised button-fill color-red" onclick="stoprecordin()">Stop Recording</a><br>
                                            <a href="#" class="button button-raised button-fill color-black prompt-title-ok-cancel" onclick="senddata()">Send Data</a></p><br>
											<a href="exercise.html" class="button button-raised button-fill color-green">Exercise</a>
                                        </div>
                                    </div>
                                </div>
								<!-- Distance calculation -->
								<!-- <div class="col-100">
                                    <div class="card">
                                        <div class="card-header">Distance</div>
                                        <div class="card-content">
                                            <div class="card-content-inner">
											<p><a href="#" class="button button-raised button-fill color-blue "onclick="calAcc()">Get Distance</a><br>
											</div>
                                        </div>
                                    </div>
                                </div> -->
                                <!-- Device Info -->
                                <div class="col-100">
                                    <div class="card">
                                        <div class="card-header">Device Info</div>
                                        <div class="card-content">
                                            <div class="card-content-inner">SensorTag device model: <span id="DeviceModel">?</span><br /> Firmware version:
                                                <span id="FirmwareData">?</span></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- end of page content -->
                </div>
            </div>
        </div>
    </div>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
   
    <!-- Path to Framework7 Library JS-->
    <script type="text/javascript" src="js/framework7.min.js"></script>
    <!-- Path to your app js-->
    <script type="text/javascript" src="js/my-app.js"></script>
	<script type="text/javascript" src="js/distance.js"></script>
    <script src="libs/evothings/evothings.js"></script>
    <script src="libs/evothings/ui/ui.js"></script>
    <script src="libs/evothings/tisensortag/tisensortag.js"></script>
    <script>
        // SensorTag object.
        

        function initialiseSensorTag() {
            // Create SensorTag CC2650 instance.
            sensortag = evothings.tisensortag.createInstance(
                evothings.tisensortag.CC2650_BLUETOOTH_SMART)

            // Uncomment to use SensorTag CC2541.
            //sensortag = evothings.tisensortag.createInstance(
            //	evothings.tisensortag.CC2541_BLUETOOTH_SMART)

            //
            // Here sensors are set up.
            //
            // If you wish to use only one or a few sensors, just set up
            // the ones you wish to use.
            //
            // First parameter to sensor function is the callback function.
            // Several of the sensors take a millisecond update interval
            // as the second parameter.
            //
            sensortag
                .statusCallback(statusHandler)
                .errorCallback(errorHandler)
                .keypressCallback(keypressHandler)
                .temperatureCallback(temperatureHandler, 1000)
                .humidityCallback(humidityHandler, 1000)
                .barometerCallback(barometerHandler, 1000)
                .accelerometerCallback(accelerometerHandler, 1000)
                .magnetometerCallback(magnetometerHandler, 1000)
                .gyroscopeCallback(gyroscopeHandler, 1000)
                .luxometerCallback(luxometerHandler, 1000)
        }

        function connect() {
            sensortag.connectToNearestDevice()
        }

        function disconnect() {
            sensortag.disconnectDevice()
            resetSensorDisplayValues()
        }

        var sensorsOn = true

        function toggleSensors() {
            if (sensorsOn) {
                sensortag.keypressOff()
                sensortag.temperatureOff()
                sensortag.humidityOff()
                sensortag.barometerOff()
                sensortag.accelerometerOff()
                sensortag.magnetometerOff()
                sensortag.gyroscopeOff()
                sensortag.luxometerOff()
                sensorsOn = false
            } else {
                sensortag.keypressOn()
                sensortag.temperatureOn()
                sensortag.humidityOn()
                sensortag.barometerOn()
                sensortag.accelerometerOn()
                sensortag.magnetometerOn()
                sensortag.gyroscopeOn()
                sensortag.luxometerOn()
                sensorsOn = true
            }
        }

        function statusHandler(status) {
            if ('DEVICE_INFO_AVAILABLE' == status) {
                // Show a notification about that the firmware should be
                // upgraded if the connected device is a SensorTag CC2541
                // with firmware revision less than 1.5, since this the
                // SensorTag library does not support these versions.
                var upgradeNotice = document.getElementById('upgradeNotice')
                if ('CC2541' == sensortag.getDeviceModel() &&
                    parseFloat(sensortag.getFirmwareString()) < 1.5) {
                    upgradeNotice.classList.remove('hidden')
                } else {
                    upgradeNotice.classList.add('hidden')
                }

                // Show device model and firmware version.
                displayValue('DeviceModel', sensortag.getDeviceModel())
                displayValue('FirmwareData', sensortag.getFirmwareString())

                // Show which sensors are not supported by the connected SensorTag.
                if (!sensortag.isLuxometerAvailable()) {
                    document.getElementById('Luxometer').style.display = 'none'
                }
            }

            displayValue('StatusData', status)
        }

        function errorHandler(error) {
            console.log('Error: ' + error)

            if (evothings.easyble.error.DISCONNECTED == error) {
                resetSensorDisplayValues()
            } else {
                displayValue('StatusData', 'Error: ' + error)
            }
        }

        function resetSensorDisplayValues() {
            // Clear current values.
            var blank = '[Waiting for value]'
            displayValue('StatusData', 'Press Connect to find a SensorTag')
            displayValue('DeviceModel', '?')
            displayValue('FirmwareData', '?')
            displayValue('KeypressData', blank)
            displayValue('TemperatureData', blank)
            displayValue('AccelerometerData', blank)
            displayValue('HumidityData', blank)
            displayValue('MagnetometerData', blank)
            displayValue('BarometerData', blank)
            displayValue('GyroscopeData', blank)
            displayValue('LuxometerData', blank)

            // Reset screen color.
            setBackgroundColor('white')
        }

        function keypressHandler(data) {
            // Update background color.
            switch (data[0]) {
                case 0:
                    setBackgroundColor('white')
                    break;
                case 1:
                    setBackgroundColor('red')
                    break;
                case 2:
                    setBackgroundColor('blue')
                    break;
                case 3:
                    setBackgroundColor('magenta')
                    break;
            }

            // Update the value displayed.
            var string = 'raw: 0x' + bufferToHexStr(data, 0, 1)
            displayValue('KeypressData', string)
        }

        function temperatureHandler(data) {
            // Calculate temperature from raw sensor data.
            var values = sensortag.getTemperatureValues(data)
            var ac = values.ambientTemperature
            var af = sensortag.celsiusToFahrenheit(ac)
            var tc = values.targetTemperature
            var tf = sensortag.celsiusToFahrenheit(tc)

            // Prepare the information to display.
            var string =
                //'raw: <span style="font-family: monospace;">0x' +
                //	bufferToHexStr(data, 0, 4) + '</span><br/>' +
                (tc >= 0 ? '+' : '') + tc.toFixed(2) + '&deg; C ' +
                '(' + (tf >= 0 ? '+' : '') + tf.toFixed(2) + '&deg; F)' + '<br/>' +
                (ac >= 0 ? '+' : '') + ac.toFixed(2) + '&deg; C ' +
                '(' + (af >= 0 ? '+' : '') + af.toFixed(2) + '&deg; F) [amb]' +
                '<br/>'

            // Update the value displayed.
            displayValue('TemperatureData', string)
        }

        function accelerometerHandler(data) {
            // Calculate the x,y,z accelerometer values from raw data.
            var values = sensortag.getAccelerometerValues(data)
            var x = values.x
            var y = values.y
            var z = values.z
            var currentDate = new Date(),
			     time1 = currentDate.getTime();
                //day = currentDate.getDate(),
                //month = currentDate.getMonth() + 1,
                //year = currentDate.getFullYear(),
                //hours = currentDate.getHours(),
                //minutes = currentDate.getMinutes();
                //seconds= currentDate.getSeconds();
                //milliseconds= currentDate.getMilliseconds();
                //if (minutes < 10) {
                //minutes = "0" + minutes;
				//}
  var time= time1 ;
      
            if (recording)bigdata.push([time,x,y,z])
            
			
            
            //var model = sensortag.getDeviceModel()
            //var dataOffset = (model == 2 ? 6 : 0)

            // Prepare the information to display.
            string =
                //'raw: <span style="font-family: monospace;">0x' +
                //	bufferToHexStr(data, dataOffset, 6) + '</span><br/>' +
                'x: ' + (x >= 0 ? '+' : '') + x.toFixed(5) + 'G<br/>' +
                'y: ' + (y >= 0 ? '+' : '') + y.toFixed(5) + 'G<br/>' +
                'z: ' + (z >= 0 ? '+' : '') + z.toFixed(5) + 'G<br/>'

            // Update the value displayed.
            displayValue('AccelerometerData', string)
        }

        function humidityHandler(data) {
            // Calculate the humidity values from raw data.
            var values = sensortag.getHumidityValues(data)

            // Calculate the humidity temperature (C and F).
            var tc = values.humidityTemperature
            var tf = sensortag.celsiusToFahrenheit(tc)

            // Calculate the relative humidity.
            var h = values.relativeHumidity

            // Prepare the information to display.
            string =
                //'raw: <span style="font-family: monospace;">0x' +
                //	bufferToHexStr(data, 0, 4) + '</span><br/>'
                (tc >= 0 ? '+' : '') + tc.toFixed(2) + '&deg; C ' +
                '(' + (tf >= 0 ? '+' : '') + tf.toFixed(2) + '&deg; F)' + '<br/>' +
                (h >= 0 ? '+' : '') + h.toFixed(2) + '% RH' + '<br/>'

            // Update the value displayed.
            displayValue('HumidityData', string)
        }

        function magnetometerHandler(data) {
            // Calculate the magnetometer values from raw sensor data.
            var values = sensortag.getMagnetometerValues(data)
            var x = values.x
            var y = values.y
            var z = values.z

            //var model = sensortag.getDeviceModel()
            //var dataOffset = (model == 2 ? 12 : 0)

            // Prepare the information to display.
            string =
                //'raw: <span style="font-family: monospace;">0x' +
                //	bufferToHexStr(data, dataOffset, 6) + '</span><br/>' +
                'x: ' + (x >= 0 ? '+' : '') + x.toFixed(5) + '&micro;T <br/>' +
                'y: ' + (y >= 0 ? '+' : '') + y.toFixed(5) + '&micro;T <br/>' +
                'z: ' + (z >= 0 ? '+' : '') + z.toFixed(5) + '&micro;T <br/>'

            // Update the value displayed.
            displayValue('MagnetometerData', string)
        }

        function barometerHandler(data) {
            // Calculate pressure from raw sensor data.
            var values = sensortag.getBarometerValues(data)
            var pressure = values.pressure

            // Prepare the information to display.
            string =
                //'raw: <span style="font-family: monospace;">0x' +
                //	bufferToHexStr(data, 0, 4) + '</span><br/>' +
                'Pressure: ' + pressure.toPrecision(5) + ' mbar<br/>'

            // Update the value displayed.
            displayValue('BarometerData', string)
        }

        function gyroscopeHandler(data) {
            // Calculate the gyroscope values from raw sensor data.
            var values = sensortag.getGyroscopeValues(data)
            var x = values.x
            var y = values.y
            var z = values.z

            // Prepare the information to display.
            string =
                //'raw: <span style="font-family: monospace;">0x' +
                //	bufferToHexStr(data, 0, 6) + '</span><br/>' +
                'x: ' + (x >= 0 ? '+' : '') + x.toFixed(5) + '<br/>' +
                'y: ' + (y >= 0 ? '+' : '') + y.toFixed(5) + '<br/>' +
                'z: ' + (z >= 0 ? '+' : '') + z.toFixed(5) + '<br/>'

            // Update the value displayed.
            displayValue('GyroscopeData', string)
        }

        function luxometerHandler(data) {
            var values = sensortag.getLuxometerValue(data)

            // Prepare the information to display.
            string =
                //'raw: <span style="font-family: monospace;">0x' +
                //	bufferToHexStr(data, 0, 2) + '</span><br/>' +
                'Light level: ' + values.toPrecision(5) + ' lux<br/>'

            // Update the value displayed.
            displayValue('LuxometerData', string)
        }

        function displayValue(elementId, values) {
            try { 
            document.getElementById(elementId).innerHTML = values
            }catch(e){

        

            }
        }

        function setBackgroundColor(color) {
            document.documentElement.style.background = color
            document.body.style.background = color
        }

        /**
         * Convert byte buffer to hex string.
         * @param buffer - an Uint8Array
         * @param offset - byte offset
         * @param numBytes - number of bytes to read
         * @return string with hex representation of bytes
         */
        function bufferToHexStr(buffer, offset, numBytes) {
            var hex = ''
            for (var i = 0; i < numBytes; ++i) {
                hex += byteToHexStr(buffer[offset + i])
            }
            return hex
        }

        /**
         * Convert byte number to hex string.
         */
        function byteToHexStr(d) {
            if (d < 0) {
                d = 0xFF + d + 1
            }
            var hex = Number(d).toString(16)
            var padding = 2
            while (hex.length < padding) {
                hex = '0' + hex
            }
            return hex
        }

        document.addEventListener(
            'deviceready',
            function () {
                evothings.scriptsLoaded(initialiseSensorTag)
            },
            false)
    </script>
</body>

</html>